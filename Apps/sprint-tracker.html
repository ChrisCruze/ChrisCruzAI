<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Tracker</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    
    <style>
        /* Custom styles and animations */
        :root {
            font-family: 'Inter', sans-serif;
        }
        @supports (font-variation-settings: normal) {
            :root { font-family: 'Inter var', sans-serif; }
        }

        /* Fade-in animation for smoother transitions */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        /* Custom scrollbar for a more integrated look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans flex flex-col antialiased">
    
    <!-- Main application container where content will be rendered -->
    <div id="app" class="flex flex-col flex-grow"></div>

    <script>
        // --- APPLICATION SCRIPT ---

        // --- Configuration & Constants ---
        const AIRTABLE_CONFIG = {
            API_KEY: "patdMoOPya9xAXGLG.3a26ab9163b441fa24a5e1edc3d775c4608e447dd7c0ffa50d6de697d121c022",
            BASE_ID: "appwECc0zockq6Dbe",
            TABLE_ID: "tblJwrhyAA2gaHfE3",
        };
        const API_URL = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.BASE_ID}/${AIRTABLE_CONFIG.TABLE_ID}`;
        const AIRTABLE_VIEW_URL = "https://airtable.com/appwECc0zockq6Dbe/tblJwrhyAA2gaHfE3/viwlcOigpvL2zns6Q?blocks=hide";

        // --- State Management ---
        let state = {
            view: 'dashboard', // 'dashboard', 'pre-sprint', 'sprinting', 'summary', 'editing'
            sprints: [],
            isLoading: true,
            error: null,
            sprintToEdit: null,
            sprintToShowDetails: null,
            sprintIdToDelete: null,
            showCopyNotification: false,
            startDistance: 0,
            sprintStartTime: null,
            sprintEndTime: null,
            elapsedTime: 0,
            timerInterval: null,
        };
        
        const appContainer = document.getElementById('app');

        /**
         * A simple state management function to update state and re-render the app.
         * @param {object} newState - The new state properties to merge.
         */
        function setState(newState) {
            Object.assign(state, newState);
            renderApp();
        }

        // --- Render Functions ---

        /**
         * Main render function that builds the entire UI based on the current state.
         */
        function renderApp() {
            let content = '';
            if (state.isLoading && state.sprints.length === 0) {
                content = renderLoadingSpinner();
            } else if (state.error) {
                content = renderErrorDisplay();
            } else {
                switch (state.view) {
                    case 'pre-sprint':
                        content = renderPreSprintView();
                        break;
                    case 'sprinting':
                        content = renderSprintingView();
                        break;
                    case 'summary':
                        content = renderSummaryView();
                        break;
                    case 'editing':
                        content = renderSummaryView(true);
                        break;
                    default:
                        content = renderDashboardView();
                }
            }

            appContainer.innerHTML = `
                ${renderHeader()}
                <main class="flex-grow p-4 md:p-6 lg:p-8 relative">
                    ${content}
                </main>
                ${state.sprintToShowDetails ? renderSprintDetailModal() : ''}
                ${state.sprintIdToDelete ? renderConfirmationModal() : ''}
                ${state.showCopyNotification ? renderNotification() : ''}
            `;
            
            // Activate Lucide icons after rendering new HTML
            lucide.createIcons();
            attachEventListeners();
        }

        function renderHeader() {
            return `
            <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-20 p-4 border-b border-gray-700 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="zap" class="text-yellow-400 h-6 w-6 mr-3"></i>
                    <h1 class="text-2xl font-bold tracking-tight text-white">Sprint Tracker</h1>
                </div>
                <a href="${AIRTABLE_VIEW_URL}" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-400 hover:text-yellow-400 flex items-center transition-colors">
                    View in Airtable <i data-lucide="external-link" class="h-4 w-4 ml-1.5"></i>
                </a>
            </header>`;
        }
        
        function renderDashboardView() {
            const { sprints } = state;
            const overallStats = (() => {
                if (sprints.length === 0) return { fastestPace: 'N/A', longestDistance: 0 };
                const longestDistance = Math.max(...sprints.map(s => s['Distance'] || 0));
                const fastestPaceSprint = sprints.filter(s => s['Pace'] && s['Pace'] !== 'N/A').sort((a, b) => parsePaceToSeconds(a.Pace) - parsePaceToSeconds(b.Pace))[0];
                return { fastestPace: fastestPaceSprint ? fastestPaceSprint.Pace : 'N/A', longestDistance };
            })();

            const todayStats = (() => {
                const today = new Date().toDateString();
                const todaySprints = sprints.filter(s => new Date(s['Start Time']).toDateString() === today);
                const totalDistanceToday = todaySprints.reduce((sum, s) => sum + (s.Distance || 0), 0);
                const totalDurationToday = todaySprints.reduce((sum, s) => sum + (s['Duration (Seconds)'] || 0), 0);
                return { totalDistanceToday, totalDurationToday };
            })();

            return `
            <div class="animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    ${renderStatCard('chevrons-right', 'Total Distance Today', todayStats.totalDistanceToday.toFixed(2), 'miles', 'green')}
                    ${renderStatCard('clock', 'Total Time Today', formatDuration(todayStats.totalDurationToday), 'duration', 'blue')}
                    ${renderStatCard('wind', 'Fastest Pace', overallStats.fastestPace.split(' ')[0], 'min/mile', 'cyan')}
                    ${renderStatCard('target', 'Longest Distance', overallStats.longestDistance.toFixed(2), 'miles', 'yellow')}
                </div>
                <div class="bg-gray-800/50 rounded-xl p-4 md:p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold flex items-center"><i data-lucide="book-open" class="mr-2 h-5 w-5 text-gray-400"></i>Recent Sprints</h2>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="new-sprint-btn" class="bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-lg flex items-center hover:bg-yellow-300 transition-all shadow-lg hover:shadow-yellow-400/30 transform hover:scale-105 ml-auto">
                                <i data-lucide="plus" class="h-5 w-5 mr-2"></i> New Sprint
                            </button>
                        </div>
                    </div>
                    ${renderSprintList()}
                </div>
            </div>`;
        }
        
        function renderSprintList() {
            if (state.sprints.length === 0) return `<p class="text-center text-gray-400 py-8">No sprints logged yet. Time to get running!</p>`;
            
            const sprintsToShow = state.sprints.slice(0, 10);
            return `
            <div class="space-y-3" id="sprint-list-container">
                ${sprintsToShow.map(sprint => `
                    <div class="bg-gray-700/50 p-3 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between hover:bg-gray-700 transition-all gap-3">
                        <div class="flex items-center flex-grow w-full cursor-pointer" data-action="show-details" data-sprint-id="${sprint.id}">
                            <i data-lucide="calendar" class="h-5 w-5 text-gray-400 mr-4 flex-shrink-0"></i>
                            <div class="flex-grow">
                                <p class="font-semibold">${sprint.Name || 'Untitled Sprint'}</p>
                                <p class="text-sm text-gray-400">${new Date(sprint['Start Time']).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-end space-x-4 w-full sm:w-auto flex-shrink-0">
                            <div class="text-right"><p class="font-mono text-lg">${sprint.Pace}</p><p class="text-xs text-gray-400">Pace</p></div>
                            <div class="text-right"><p class="font-mono text-lg">${formatDuration(sprint['Duration (Seconds)'])}</p><p class="text-xs text-gray-400">Duration</p></div>
                            <div class="text-right"><p class="font-mono text-lg">${sprint.Distance?.toFixed(2) || '0.00'}</p><p class="text-xs text-gray-400">miles</p></div>
                            <div class="flex items-center border-l border-gray-600 pl-2 ml-2">
                               <button data-action="edit-sprint" data-sprint-id="${sprint.id}" class="p-2 rounded-md hover:bg-gray-600 text-gray-400 hover:text-white"><i data-lucide="edit" class="h-4 w-4 pointer-events-none"></i></button>
                               <button data-action="delete-sprint" data-sprint-id="${sprint.id}" class="p-2 rounded-md hover:bg-red-900/50 text-gray-400 hover:text-red-400"><i data-lucide="trash-2" class="h-4 w-4 pointer-events-none"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>`;
        }

        function renderPreSprintView() {
            return `
            <div class="max-w-md mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl animate-fade-in">
                <h2 class="text-3xl font-bold text-center mb-6">Ready to Sprint?</h2>
                <form id="pre-sprint-form" class="space-y-4">
                    ${renderInputField('startDistance', 'Start Distance (miles)', 'number', '', 'e.g., 120.5 (from treadmill)', true)}
                    <div class="flex justify-between pt-4">
                        <button type="button" data-action="cancel" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-all flex items-center">
                            <i data-lucide="x-circle" class="h-5 w-5 mr-2"></i> Cancel
                        </button>
                        <button type="submit" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-400 transition-all flex items-center">
                            <i data-lucide="play" class="h-5 w-5 mr-2"></i> Start
                        </button>
                    </div>
                </form>
            </div>`;
        }

        function renderSprintingView() {
            return `
            <div class="flex flex-col items-center justify-center h-full animate-fade-in text-center">
                <div class="mb-8">
                    <p class="text-gray-400 text-2xl mb-2">SPRINT IN PROGRESS</p>
                    <h2 class="text-8xl md:text-9xl font-mono font-bold text-yellow-400 tabular-nums">
                        ${formatDuration(state.elapsedTime)}
                    </h2>
                </div>
                <button data-action="stop-sprint" class="bg-red-600 text-white font-bold py-4 px-10 rounded-full text-2xl hover:bg-red-500 transition-all shadow-lg hover:shadow-red-500/40 transform hover:scale-105">
                    STOP
                </button>
            </div>`;
        }

        function renderSummaryView(isEditing = false) {
            const initialData = isEditing ? state.sprintToEdit : {};
            const name = initialData.Name || `Sprint ${new Date(state.sprintStartTime || Date.now()).toLocaleDateString()}`;
            const distance = initialData.Distance || '';
            const comments = initialData.Comments || '';
            const category = initialData.Category || '';
            const duration = isEditing ? initialData['Duration (Seconds)'] : Math.floor((state.sprintEndTime - state.sprintStartTime) / 1000);
            
            return `
            <div class="max-w-lg mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl animate-fade-in">
                <form id="summary-form" class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold">${isEditing ? 'Edit Sprint' : 'Sprint Summary'}</h2>
                        <p class="text-yellow-400 text-xl font-mono">${formatDuration(duration)}</p>
                    </div>
                    <div class="flex justify-between">
                        <button type="button" data-action="cancel" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-all flex items-center">
                            <i data-lucide="x-circle" class="h-5 w-5 mr-2"></i> Cancel
                        </button>
                        <button type="submit" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-400 transition-all flex items-center">
                            <i data-lucide="save" class="h-5 w-5 mr-2"></i> ${isEditing ? 'Update & Close' : 'Save & Copy'}
                        </button>
                    </div>
                    
                    ${!isEditing ? `
                    <div class="flex justify-between text-center bg-gray-900/50 p-3 rounded-lg">
                        <div><p class="text-xs text-gray-400">Start Time</p><p class="font-mono text-white">${new Date(state.sprintStartTime).toLocaleTimeString()}</p></div>
                        <div><p class="text-xs text-gray-400">End Time</p><p class="font-mono text-white">${new Date(state.sprintEndTime).toLocaleTimeString()}</p></div>
                    </div>` : ''}

                    ${renderInputField('name', 'Name', 'text', name, 'e.g., Morning Track Sprint')}
                    
                    ${isEditing ? 
                        renderInputField('distance', 'Distance (miles)', 'number', distance, 'e.g., 0.2', true) 
                        : `
                        <div class="bg-gray-900/50 p-4 rounded-lg space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInputField('startDistance', 'Start Distance', 'text', state.startDistance, '', false, true)}
                                ${renderInputField('endDistance', 'End Distance', 'number', '', 'e.g., 120.7', true)}
                            </div>
                            <div id="calculated-distance-container" class="text-center bg-gray-700/50 p-3 rounded-lg">
                                <p class="text-sm text-gray-400">Total Sprint Distance</p>
                                <p class="text-2xl font-bold text-yellow-400">0.00 <span class="text-base font-normal text-white">miles</span></p>
                            </div>
                        </div>`
                    }

                    ${renderInputField('category', 'Category', 'text', category, 'e.g., Endurance, Tempo')}
                    ${renderInputField('comments', 'Comments', 'textarea', comments, 'e.g., Felt strong today!')}
                </form>
            </div>`;
        }

        function renderSprintDetailModal() {
            const sprint = state.sprintToShowDetails;
            return `
            <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in" data-action="close-details-modal-overlay">
                <div class="bg-gray-800 rounded-xl shadow-2xl p-6 max-w-md w-full relative border border-gray-700">
                    <button data-action="close-details-modal" class="absolute top-3 right-3 p-1 rounded-full hover:bg-gray-700 text-gray-400 hover:text-white transition-colors">
                        <i data-lucide="x" class="h-5 w-5 pointer-events-none"></i>
                    </button>
                    <h3 class="text-2xl font-bold text-white mb-1">${sprint.Name}</h3>
                    <p class="text-sm text-gray-400 mb-4">${new Date(sprint['Start Time']).toLocaleString()}</p>
                    <div class="grid grid-cols-3 gap-4 text-center mb-6">
                        <div><p class="font-mono text-2xl text-yellow-400">${sprint.Distance?.toFixed(2)}</p><p class="text-xs text-gray-400">miles</p></div>
                        <div><p class="font-mono text-2xl text-yellow-400">${formatDuration(sprint['Duration (Seconds)'])}</p><p class="text-xs text-gray-400">Duration</p></div>
                        <div><p class="font-mono text-2xl text-yellow-400">${sprint.Pace}</p><p class="text-xs text-gray-400">Pace</p></div>
                    </div>
                    ${sprint.Category ? `<div class="mb-4"><h4 class="text-sm font-semibold text-gray-300 mb-1">Category</h4><p class="bg-gray-700/50 text-cyan-300 text-sm font-medium inline-block px-2 py-1 rounded">${sprint.Category}</p></div>` : ''}
                    ${sprint.Comments ? `<div><h4 class="text-sm font-semibold text-gray-300 mb-1">Comments</h4><p class="text-gray-300 bg-gray-900/50 p-3 rounded-lg whitespace-pre-wrap">${sprint.Comments}</p></div>` : ''}
                </div>
            </div>`;
        }

        function renderConfirmationModal() {
            return `
            <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full animate-fade-in">
                    <h3 class="text-lg font-semibold text-white mb-4">Confirm Action</h3>
                    <p class="text-gray-300 mb-6">Are you sure you want to delete this sprint? This action cannot be undone.</p>
                    <div class="flex justify-end gap-3">
                        <button data-action="cancel-delete" class="px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">Cancel</button>
                        <button data-action="confirm-delete" class="px-4 py-2 rounded-md bg-red-600 hover:bg-red-500 text-white font-semibold transition-colors">Delete</button>
                    </div>
                </div>
            </div>`;
        }
        
        // --- Component-like Render Functions ---

        function renderInputField(name, label, type = 'text', value, placeholder, required = false, disabled = false) {
            const commonClasses = "w-full bg-gray-700 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition-all";
            const disabledClasses = "read-only:bg-gray-800 read-only:cursor-not-allowed";
            return `
            <div>
                <label for="${name}" class="block text-sm font-medium text-gray-300 mb-1">${label}</label>
                ${type === 'textarea' ? `
                    <textarea id="${name}" name="${name}" placeholder="${placeholder}" rows="3" class="${commonClasses}" ${disabled ? 'disabled' : ''}>${value}</textarea>
                ` : `
                    <input id="${name}" name="${name}" type="${type}" value="${value}" placeholder="${placeholder}" ${required ? 'required' : ''} step="0.01" class="${commonClasses} ${disabledClasses}" ${disabled ? 'readonly' : ''} />
                `}
            </div>`;
        }
        
        function renderStatCard(icon, title, value, unit, color) {
            const colorClasses = { yellow: 'text-yellow-400', cyan: 'text-cyan-400', green: 'text-green-400', blue: 'text-blue-400' };
            return `
            <div class="bg-gray-800/50 p-4 rounded-xl flex items-center space-x-4">
                <div class="p-3 rounded-lg bg-gray-700 ${colorClasses[color]}"><i data-lucide="${icon}" class="h-6 w-6"></i></div>
                <div>
                    <p class="text-gray-400 text-sm">${title}</p>
                    <p class="text-2xl font-bold text-white">${value} <span class="text-base font-normal text-gray-400">${unit}</span></p>
                </div>
            </div>`;
        }
        
        function renderLoadingSpinner() {
            return `<div class="flex justify-center items-center h-full"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-yellow-400"></div></div>`;
        }

        function renderErrorDisplay() {
            return `
            <div class="text-center text-red-400 bg-red-900/50 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-2">Something went wrong</h3>
                <p class="font-mono text-sm mb-4">${state.error.message || 'An unknown error occurred'}</p>
                <button id="retry-fetch-btn" class="bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-yellow-300 transition-all">Try Again</button>
            </div>`;
        }
        
        function renderNotification() {
            return `
            <div class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg flex items-center animate-fade-in z-30">
                <i data-lucide="copy" class="h-5 w-5 mr-2"></i> Sprint details copied to clipboard!
            </div>`;
        }

        // --- Event Handling ---
        
        /**
         * Attaches all necessary event listeners to the currently rendered DOM.
         */
        function attachEventListeners() {
            // General actions on the document
            document.body.addEventListener('click', handleGeneralClick);
            
            // Forms
            const preSprintForm = document.getElementById('pre-sprint-form');
            if (preSprintForm) preSprintForm.addEventListener('submit', handleConfirmStart);
            
            const summaryForm = document.getElementById('summary-form');
            if (summaryForm) summaryForm.addEventListener('submit', handleSaveOrUpdate);

            // Dynamic calculation on summary form
            const endDistanceInput = document.getElementById('endDistance');
            if (endDistanceInput) endDistanceInput.addEventListener('input', updateCalculatedDistance);
        }
        
        /**
         * Uses event delegation to handle clicks on various elements.
         */
        function handleGeneralClick(e) {
            const target = e.target;
            const action = target.dataset.action || target.closest('[data-action]')?.dataset.action;

            if (!action) return;

            const sprintId = target.dataset.sprintId || target.closest('[data-sprint-id]')?.dataset.sprintId;

            switch (action) {
                case 'cancel': handleCancel(); break;
                case 'stop-sprint': handleStopSprint(); break;
                case 'close-details-modal':
                case 'close-details-modal-overlay':
                    if (target.dataset.action === 'close-details-modal' || e.currentTarget === target) {
                         setState({ sprintToShowDetails: null });
                    }
                    break;
                case 'cancel-delete': setState({ sprintIdToDelete: null }); break;
                case 'confirm-delete': handleDeleteSprint(); break;
                case 'show-details': handleShowDetails(sprintId); break;
                case 'edit-sprint': handleEditSprint(sprintId); break;
                case 'delete-sprint': setState({ sprintIdToDelete: sprintId }); break;
            }
            
            // Specific button IDs for non-delegated actions
            if (target.id === 'new-sprint-btn') handleStartSprint();
            if (target.id === 'retry-fetch-btn') fetchSprints();
        }

        function handleStartSprint() {
            setState({ view: 'pre-sprint' });
        }

        function handleConfirmStart(e) {
            e.preventDefault();
            const startDistance = document.getElementById('startDistance').value;
            setState({
                startDistance: parseFloat(startDistance) || 0,
                sprintStartTime: Date.now(),
                elapsedTime: 0,
                view: 'sprinting',
            });
            state.timerInterval = setInterval(() => {
                setState({ elapsedTime: Math.floor((Date.now() - state.sprintStartTime) / 1000) });
            }, 1000);
        }

        function handleStopSprint() {
            clearInterval(state.timerInterval);
            setState({ view: 'summary', sprintEndTime: Date.now(), timerInterval: null });
        }
        
        function handleCancel() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            setState({ view: 'dashboard', error: null, sprintToEdit: null, timerInterval: null });
        }
        
        function handleShowDetails(sprintId) {
            const sprint = state.sprints.find(s => s.id === sprintId);
            if (sprint) setState({ sprintToShowDetails: sprint });
        }

        function handleEditSprint(sprintId) {
            const sprint = state.sprints.find(s => s.id === sprintId);
            if(sprint) setState({ sprintToEdit: sprint, view: 'editing' });
        }

        async function handleDeleteSprint() {
            const sprintId = state.sprintIdToDelete;
            setState({ isLoading: true, sprintIdToDelete: null });
            try {
                await airtableRequest(`${API_URL}/${sprintId}`, 'DELETE');
                state.sprints = state.sprints.filter(s => s.id !== sprintId); // Manual update before re-render
                setState({ isLoading: false });
            } catch(err) {
                console.error("Error deleting sprint:", err);
                await fetchSprints(); // Refetch on error
            }
        }
        
        async function handleSaveOrUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const formData = {
                name: form.name.value,
                comments: form.comments.value,
                category: form.category.value,
                distance: form.distance ? parseFloat(form.distance.value) : 0,
            };

            if (state.view === 'editing') {
                if (!formData.distance || formData.distance <= 0) {
                     alert("Please enter a valid, positive distance."); return;
                }
                await updateSprint(state.sprintToEdit.id, formData);
            } else {
                const endDistance = parseFloat(form.endDistance.value);
                const calculatedDistance = (endDistance > state.startDistance) ? (endDistance - state.startDistance) : 0;
                if (calculatedDistance <= 0) {
                    alert("Please enter an End Distance greater than the Start Distance."); return;
                }
                formData.distance = calculatedDistance;
                await saveSprint(formData);
            }
        }
        
        function updateCalculatedDistance(e) {
            const end = parseFloat(e.target.value);
            const start = state.startDistance;
            const distance = (!isNaN(end) && !isNaN(start) && end > start) ? (end - start) : 0;
            const container = document.getElementById('calculated-distance-container');
            if (container) {
                container.innerHTML = `
                    <p class="text-sm text-gray-400">Total Sprint Distance</p>
                    <p class="text-2xl font-bold text-yellow-400">${distance.toFixed(2)} <span class="text-base font-normal text-white">miles</span></p>`;
            }
        }

        // --- API & Data Functions ---
        
        /**
         * Fetches all sprints from Airtable and updates the state.
         */
        async function fetchSprints() {
            setState({ isLoading: true, error: null });
            try {
                const url = `${API_URL}?sort%5B0%5D%5Bfield%5D=Start+Time&sort%5B0%5D%5Bdirection%5D=desc`;
                const data = await airtableRequest(url, 'GET');
                const formattedSprints = data.records.map(record => ({
                    id: record.id,
                    ...record.fields,
                    'Distance': record.fields['Distance'] || 0,
                    'Duration (Seconds)': record.fields['Duration (Seconds)'] || 0,
                    'Pace': record.fields['Pace'] || 'N/A',
                }));
                setState({ sprints: formattedSprints, isLoading: false });
            } catch (err) {
                console.error("Error fetching sprints:", err);
                setState({ error: err, isLoading: false });
            }
        }

        async function saveSprint(formData) {
            setState({ isLoading: true });
            const duration = Math.floor((state.sprintEndTime - state.sprintStartTime) / 1000);
            const pace = calculatePace(formData.distance, duration);
            
            const newRecord = {
                fields: {
                    "Name": formData.name,
                    "Start Time": new Date(state.sprintStartTime).toISOString(),
                    "End Time": new Date(state.sprintEndTime).toISOString(),
                    "Distance": parseFloat(formData.distance),
                    "Comments": formData.comments,
                    "Category": formData.category,
                },
            };

            try {
                await airtableRequest(API_URL, 'POST', newRecord);
                copyToClipboard({ ...formData, startTime: state.sprintStartTime, endTime: state.sprintEndTime, duration, pace });
                await fetchSprints();
                setState({ view: 'dashboard' });
            } catch (err) {
                console.error("Error saving sprint:", err);
                setState({ error: err, isLoading: false, view: 'summary' });
            }
        }
        
        async function updateSprint(sprintId, formData) {
             setState({ isLoading: true });
            const updatedRecord = { fields: { ...formData } };
            try {
                await airtableRequest(`${API_URL}/${sprintId}`, 'PATCH', updatedRecord);
                await fetchSprints();
                setState({ view: 'dashboard', sprintToEdit: null });
            } catch(err) {
                console.error("Error updating sprint:", err);
                setState({ error: err, isLoading: false, view: 'editing' });
            }
        }

        /**
         * Robust fetch wrapper for Airtable API with retries.
         */
        async function airtableRequest(url, method, body = null) {
            let lastError = null;
            for (let i = 0; i < 3; i++) { // Retry up to 3 times
                try {
                    const options = {
                        method: method,
                        headers: {
                            Authorization: `Bearer ${AIRTABLE_CONFIG.API_KEY}`,
                            'Content-Type': 'application/json',
                        },
                    };
                    if (body) options.body = JSON.stringify(body);
                    
                    const response = await fetch(url, options);

                    if (response.ok) {
                        return method === 'DELETE' ? {} : await response.json();
                    }
                    
                    const errorData = await response.json();
                    lastError = new Error(`Airtable API Error: ${errorData.error?.message || response.statusText}`);
                    if (response.status >= 400 && response.status < 500) break;

                } catch (error) { lastError = error; }
                if (i < 2) await new Promise(res => setTimeout(res, 1000));
            }
            throw lastError;
        }

        // --- Utility Functions ---

        function copyToClipboard(sprintDetails) {
            const textToCopy = `
Sprint Summary:
-------------------------
Name: ${sprintDetails.name}
Date: ${new Date(sprintDetails.startTime).toLocaleDateString()}
Start Time: ${new Date(sprintDetails.startTime).toLocaleTimeString()}
End Time: ${new Date(sprintDetails.endTime).toLocaleTimeString()}
Duration: ${formatDuration(sprintDetails.duration)}
Distance: ${sprintDetails.distance.toFixed(2)} miles
Pace: ${sprintDetails.pace} min/mile
Category: ${sprintDetails.category || 'N/A'}
Comments: ${sprintDetails.comments || 'N/A'}
            `.trim();

            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                setState({ showCopyNotification: true });
                setTimeout(() => setState({ showCopyNotification: false }), 3000);
            } catch (err) { console.error('Failed to copy text: ', err); }
            document.body.removeChild(textArea);
        };
        
        function formatDuration(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00";
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        function parsePaceToSeconds(paceStr) {
            if (!paceStr || typeof paceStr !== 'string' || paceStr === 'N/A') return Infinity;
            const parts = paceStr.split(' ')[0].split(':');
            if (parts.length !== 2) return Infinity;
            return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
        };

        function calculatePace(distance, durationSeconds) {
            if (!distance || distance <= 0 || !durationSeconds || durationSeconds <= 0) return "N/A";
            const paceDecimal = (durationSeconds / 60) / distance;
            const paceMinutes = Math.floor(paceDecimal);
            const paceSeconds = Math.round((paceDecimal - paceMinutes) * 60);
            return `${String(paceMinutes).padStart(2, '0')}:${String(paceSeconds).padStart(2, '0')}`;
        };

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', fetchSprints);

    </script>
</body>
</html>
