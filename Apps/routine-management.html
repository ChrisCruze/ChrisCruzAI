<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routine Management App</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React and ReactDOM for UI rendering -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX transpilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (using module scripts to get the latest V9+ API) -->
    <script type="module">
        // We import the necessary Firebase functions and attach them to the global window object
        // so our main React script (which runs via Babel) can access them.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        
        window.FirebaseV9 = {
            initializeApp,
            getDatabase,
            ref,
            onValue,
            set,
            push,
            remove
        };
    </script>
</head>
<body class="bg-gray-50">
    <!-- The root element where our React app will be mounted -->
    <div id="root"></div>

    <!-- The main application script, written in JSX and transpiled by Babel -->
    <script type="text/babel">
        // Destructure necessary functions from the global objects provided by the CDN scripts
        const { useState, useEffect, useCallback } = React;
        const { initializeApp, getDatabase, ref, onValue, set, push, remove } = window.FirebaseV9;

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCsT8RKgb9Ya4zW8SfMrUY4ovxLS6n39v8",
          authDomain: "chriscruz-d62ea.firebaseapp.com",
          databaseURL: "https://chriscruz-d62ea-default-rtdb.firebaseio.com",
          projectId: "chriscruz-d62ea",
          storageBucket: "chriscruz-d62ea.firebasestorage.app",
          messagingSenderId: "817856028090",
          appId: "1:817856028090:web:983d8c52bb3c7202dc5183",
          measurementId: "G-LVHF0VP8RM"
        };

        // --- Todoist API Configuration ---
        const TODOIST_API_TOKEN = "a14f98a6b546b044dbb84bcd8eee47fbe3788671";
        const TODOIST_API_URL = "https://api.todoist.com/rest/v2/tasks";

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Helper Components ---

        // A simple modal component for forms
        const Modal = ({ children, onClose }) => (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-lg shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
              <div className="p-6 relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
                {children}
              </div>
            </div>
          </div>
        );

        // A reusable input component
        const Input = ({ label, value, onChange, placeholder, type = 'text', name, required = false, min, max }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <input
                    type={type}
                    name={name}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    required={required}
                    min={min}
                    max={max}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                />
            </div>
        );

        // A reusable textarea component
        const Textarea = ({ label, value, onChange, placeholder, name, rows = 3 }) => (
             <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <textarea
                    name={name}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    rows={rows}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                />
            </div>
        );

        // --- Form Component for Create/Edit ---
        const RoutineForm = ({ initialData, onSave, onClose }) => {
          const [routine, setRoutine] = useState({
            content: '',
            description: '',
            project_id: '',
            labels: '', // Storing labels as a comma-separated string in the form
            priority: 4,
            duration: 0,
            duration_unit: 'minute',
            due_string: ''
          });
          const [aiInput, setAiInput] = useState('');
          const [isAiLoading, setIsAiLoading] = useState(false);
          const [aiError, setAiError] = useState('');


          useEffect(() => {
            if (initialData) {
              setRoutine({
                  ...initialData,
                  labels: Array.isArray(initialData.labels) ? initialData.labels.join(', ') : '',
              });
            }
          }, [initialData]);

          const handleChange = (e) => {
            const { name, value } = e.target;
            setRoutine(prev => ({ ...prev, [name]: value }));
          };

          const handleAiAssist = async () => {
              if (!aiInput.trim()) {
                  setAiError("Please describe the routine you want to create.");
                  return;
              }
              setIsAiLoading(true);
              setAiError('');

              const prompt = `
                You are an expert task management assistant. Your job is to parse a user's description of a routine and extract structured data from it.
                The current time is ${new Date().toString()}.
                Analyze the following user input and fill in the fields of the JSON object below.

                User Input: "${aiInput}"

                JSON structure to populate:
                {
                  "content": "A short, clear title for the routine. Start with 'Routine: ' if appropriate.",
                  "description": "A detailed description. If the user provides a URL or shortcut, include it here.",
                  "project_id": "Extract any specific project ID if mentioned.",
                  "labels": "A comma-separated string of relevant labels (e.g., 'Health, Morning, 10min').",
                  "priority": "An integer from 1 (normal) to 4 (urgent). Default to 4 if high priority is implied.",
                  "duration": "An integer representing the time commitment.",
                  "duration_unit": "The unit for the duration, either 'minute' or 'day'.",
                  "due_string": "A human-readable due date string (e.g., 'today at 8am', 'every weekday')."
                }

                Only return the populated JSON object, nothing else.
              `;

              try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Will be provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                
                const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsedAiData = JSON.parse(jsonString);

                setRoutine(prev => ({
                    ...prev,
                    ...parsedAiData,
                    labels: Array.isArray(parsedAiData.labels) ? parsedAiData.labels.join(', ') : parsedAiData.labels || '',
                }));

              } catch (error) {
                  console.error("AI Assist Error:", error);
                  setAiError("Failed to generate routine with AI. Please try again or fill the form manually.");
              } finally {
                  setIsAiLoading(false);
              }
          };


          const handleSubmit = (e) => {
            e.preventDefault();
            const dataToSave = {
              ...routine,
              labels: routine.labels.split(',').map(label => label.trim()).filter(Boolean),
              priority: Number(routine.priority) || 4,
              duration: Number(routine.duration) || 0
            };
            onSave(dataToSave);
          };

          return (
            <form onSubmit={handleSubmit} className="space-y-6">
                <h2 className="text-2xl font-bold text-gray-900">{initialData ? 'Edit Routine' : 'Create New Routine'}</h2>
                
                <div className="p-4 border border-dashed border-indigo-300 rounded-lg bg-indigo-50">
                    <h3 className="font-semibold text-lg text-indigo-800 mb-2">AI Assist</h3>
                    <p className="text-sm text-indigo-600 mb-3">Describe your routine, and let AI fill out the form for you.</p>
                    <Textarea 
                        name="ai_input"
                        value={aiInput}
                        onChange={(e) => setAiInput(e.target.value)}
                        placeholder="e.g., Meditate for 10 minutes every morning at 7am. It's a high priority task for my 'Mindfulness' project."
                    />
                    <button 
                        type="button" 
                        onClick={handleAiAssist}
                        disabled={isAiLoading}
                        className="w-full px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 disabled:bg-indigo-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                        {isAiLoading ? (
                            <React.Fragment>
                                <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Generating...
                            </React.Fragment>
                        ) : 'Generate with AI'}
                    </button>
                    {aiError && <p className="text-red-500 text-sm mt-2">{aiError}</p>}
                </div>

                <Input label="Content (Title)" name="content" value={routine.content} onChange={handleChange} placeholder="e.g., Routine: Meditation" required />
                <Textarea label="Description" name="description" value={routine.description} onChange={handleChange} placeholder="e.g., Complete 5-minute mindfulness session." />
                <Input label="Due String" name="due_string" value={routine.due_string} onChange={handleChange} placeholder="e.g., today at 7am" />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Input label="Project ID" name="project_id" value={routine.project_id} onChange={handleChange} placeholder="e.g., 2159896039" />
                    <Input label="Labels (comma-separated)" name="labels" value={routine.labels} onChange={handleChange} placeholder="e.g., 5min, Phone, Routine" />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <Input label="Priority (1-4)" name="priority" type="number" min="1" max="4" value={routine.priority} onChange={handleChange} />
                    <Input label="Duration" name="duration" type="number" min="0" value={routine.duration} onChange={handleChange} />
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Duration Unit</label>
                        <select name="duration_unit" value={routine.duration_unit} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="minute">Minute</option>
                            <option value="day">Day</option>
                        </select>
                    </div>
                </div>
                
                <div className="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Routine</button>
                </div>
            </form>
          );
        };
        

        // --- Main App Component ---
        function App() {
          const [routines, setRoutines] = useState({});
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingRoutine, setEditingRoutine] = useState(null);

          const routinesRef = ref(db, 'routines');

          // --- Fetch Routines from Firebase ---
          useEffect(() => {
            setIsLoading(true);
            const unsubscribe = onValue(routinesRef, (snapshot) => {
              const data = snapshot.val();
              setRoutines(data || {});
              setIsLoading(false);
            }, (err) => {
              console.error("Firebase Read Error:", err);
              setError("Failed to fetch routines. Please check your Firebase connection and rules.");
              setIsLoading(false);
            });

            // Cleanup subscription on unmount
            return () => unsubscribe();
          }, []);

          // --- CRUD Operations ---
          const handleSaveRoutine = (routineData) => {
            try {
              const routineId = editingRoutine && editingRoutine.id ? editingRoutine.id : push(routinesRef).key;
              const routineToSaveRef = ref(db, `routines/${routineId}`);
              set(routineToSaveRef, routineData);
              closeModal();
            } catch(err) {
                console.error("Firebase Write Error:", err);
                setError("Failed to save routine.");
            }
          };

          const handleDeleteRoutine = (id) => {
            if (window.confirm("Are you sure you want to delete this routine?")) {
                try {
                    const routineToDeleteRef = ref(db, `routines/${id}`);
                    remove(routineToDeleteRef);
                } catch(err) {
                    console.error("Firebase Delete Error:", err);
                    setError("Failed to delete routine.");
                }
            }
          };

          // --- Todoist Integration ---
          const handleAddToTodoist = async (routine) => {
            const task = {
              content: routine.content,
              description: routine.description,
              project_id: routine.project_id,
              labels: routine.labels,
              priority: routine.priority,
              due_string: routine.due_string,
              duration: routine.duration,
              duration_unit: routine.duration_unit,
            };

            try {
              const response = await fetch(TODOIST_API_URL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${TODOIST_API_TOKEN}`,
                },
                body: JSON.stringify(task),
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Todoist API Error: ${errorData.error || response.statusText}`);
              }
              
              alert('Task successfully created in Todoist!');

            } catch (err) {
              console.error("Todoist API Error:", err);
              alert(`Failed to create task in Todoist. ${err.message}`);
            }
          };

          // --- Modal Control ---
          const openModal = (routine = null) => {
            setEditingRoutine(routine);
            setIsModalOpen(true);
          };

          const closeModal = () => {
            setIsModalOpen(false);
            setEditingRoutine(null);
          };

          // --- Render Methods ---
          const renderRoutines = () => {
            if (isLoading) {
              return <p className="text-center text-gray-500">Loading routines...</p>;
            }
            
            if (error) {
                return <p className="text-center text-red-500 bg-red-100 p-4 rounded-md">{error}</p>;
            }

            const routineEntries = Object.entries(routines);

            if (routineEntries.length === 0) {
              return (
                <div className="text-center text-gray-500 mt-8 p-6 bg-white rounded-lg shadow-md">
                    <h3 className="text-xl font-semibold">No routines yet!</h3>
                    <p className="mt-2">Click the "Add New Routine" button to get started.</p>
                </div>
              );
            }

            return (
              <div className="space-y-4">
                {routineEntries.map(([id, routine]) => (
                  <div key={id} className="bg-white p-5 rounded-lg shadow-md border border-gray-200 transition-shadow hover:shadow-lg">
                    <h3 className="text-xl font-bold text-gray-800">{routine.content}</h3>
                    <p className="text-gray-600 mt-2 whitespace-pre-wrap">{routine.description}</p>
                    <div className="mt-4 text-sm text-gray-500 grid grid-cols-2 gap-x-4 gap-y-1">
                      <p><strong>Project ID:</strong> {routine.project_id || 'N/A'}</p>
                      <p><strong>Due:</strong> {routine.due_string || 'N/A'}</p>
                      <p><strong>Priority:</strong> {routine.priority || 'N/A'}</p>
                      <p><strong>Duration:</strong> {routine.duration ? `${routine.duration} ${routine.duration_unit}` : 'N/A'}</p>
                      <p className="col-span-2"><strong>Labels:</strong> {(routine.labels || []).join(', ')}</p>
                    </div>
                    <div className="mt-4 flex flex-wrap gap-2">
                      <button onClick={() => openModal({ id, ...routine })} className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors text-sm font-semibold">Edit</button>
                      <button onClick={() => handleDeleteRoutine(id)} className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors text-sm font-semibold">Delete</button>
                      <button onClick={() => handleAddToTodoist(routine)} className="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm font-semibold">Add to Todoist</button>
                    </div>
                  </div>
                ))}
              </div>
            );
          };

          return (
            <div className="min-h-screen font-sans">
              <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                <header className="text-center mb-8">
                  <h1 className="text-4xl font-extrabold text-gray-800">Routine Management</h1>
                  <p className="text-lg text-gray-500 mt-2">Create, manage, and sync your daily routines with AI assistance.</p>
                </header>
                
                <div className="max-w-3xl mx-auto">
                    <div className="mb-6 text-center">
                        <button onClick={() => openModal()} className="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition-all transform hover:scale-105">
                            Add New Routine
                        </button>
                    </div>
                    {renderRoutines()}
                </div>
              </div>

              {isModalOpen && (
                <Modal onClose={closeModal}>
                  <RoutineForm
                    initialData={editingRoutine}
                    onSave={handleSaveRoutine}
                    onClose={closeModal}
                  />
                </Modal>
              )}
            </div>
          );
        }

        // --- Mount the App to the DOM ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
