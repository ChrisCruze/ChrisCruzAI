<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todoist Project Matrix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #eef2ff 0%, #ffffff 100%);
            min-height: 100vh;
        }
        .project-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -15px rgba(79, 70, 229, 0.4);
        }
    </style>
</head>
<body class="text-gray-900">
    <main class="max-w-6xl mx-auto px-4 py-10">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-slate-900">Todoist Project Matrix</h1>
            <p class="text-lg text-slate-600 mt-3">Stay focused on what matters most across your projects.</p>
        </header>

        <section id="matrix-view" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-md p-5 border border-slate-100">
                <h2 class="text-lg font-bold text-red-600 mb-3 border-b border-red-200 pb-2">Urgent &amp; Important (Do)</h2>
                <div id="quadrant-do" class="min-h-[220px] space-y-3 bg-red-50 rounded-lg p-3"></div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-5 border border-slate-100">
                <h2 class="text-lg font-bold text-blue-600 mb-3 border-b border-blue-200 pb-2">Important &amp; Not Urgent (Schedule)</h2>
                <div id="quadrant-schedule" class="min-h-[220px] space-y-3 bg-blue-50 rounded-lg p-3"></div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-5 border border-slate-100">
                <h2 class="text-lg font-bold text-yellow-600 mb-3 border-b border-yellow-200 pb-2">Urgent &amp; Not Important (Delegate)</h2>
                <div id="quadrant-delegate" class="min-h-[220px] space-y-3 bg-yellow-50 rounded-lg p-3"></div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-5 border border-slate-100">
                <h2 class="text-lg font-bold text-green-600 mb-3 border-b border-green-200 pb-2">Not Urgent &amp; Not Important (Eliminate)</h2>
                <div id="quadrant-eliminate" class="min-h-[220px] space-y-3 bg-green-50 rounded-lg p-3"></div>
            </div>
        </section>

        <footer class="text-center text-sm text-slate-500 mt-12">
            Data syncs live from your Todoist Project Planner workspace.
        </footer>
    </main>

    <script type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsT8RKgb9Ya4zW8SfMrUY4ovxLS6n39v8",
            authDomain: "chriscruz-d62ea.firebaseapp.com",
            databaseURL: "https://chriscruz-d62ea-default-rtdb.firebaseio.com",
            projectId: "chriscruz-d62ea",
            storageBucket: "chriscruz-d62ea.firebasestorage.app",
            messagingSenderId: "817856028090",
            appId: "1:817856028090:web:983d8c52bb3c7202dc5183",
            measurementId: "G-LVHF0VP8RM"
        };

        const todoistAPIKey = "a14f98a6b546b044dbb84bcd8eee47fbe3788671";

        const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const projectsRef = ref(database, 'projects');

        const quadrants = {
            do: document.getElementById('quadrant-do'),
            schedule: document.getElementById('quadrant-schedule'),
            delegate: document.getElementById('quadrant-delegate'),
            eliminate: document.getElementById('quadrant-eliminate')
        };

        let allProjects = {};
        let allTodoistTasks = [];
        let allCompletedTodoistTasks = [];

        const statusStyles = {
            'Not Started': 'bg-slate-200 text-slate-800',
            'In Progress': 'bg-blue-200 text-blue-800',
            'On Hold': 'bg-amber-200 text-amber-800',
            'Completed': 'bg-emerald-200 text-emerald-800'
        };

        function clearQuadrants() {
            Object.values(quadrants).forEach(q => q.innerHTML = '');
        }

        function createBadge({ text, icon, baseClass }) {
            if (!text && text !== 0) return '';
            const iconMarkup = icon ? ` <i class="${icon}"></i>` : '';
            return `<span class="ml-2 ${baseClass} text-xs font-semibold px-2.5 py-1 rounded-full inline-flex items-center gap-1">${text}${iconMarkup}</span>`;
        }

        function createMatrixCard(project) {
            const card = document.createElement('div');
            card.className = 'project-card bg-white border border-slate-200 rounded-lg p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 shadow-sm';

            const hyperlinkCount = project.hyperlinks ? Object.keys(project.hyperlinks).length : 0;
            const todoistCount = project.todoistCurrentCount || 0;
            const minutesLogged = project.kpiMinutes || 0;
            const status = project.status || 'Not Started';

            const statusBadge = `<span class="text-xs font-semibold px-2 py-1 rounded-full ${statusStyles[status] || statusStyles['Not Started']}">${status}</span>`;
            const minutesBadge = createBadge({ text: Math.round(minutesLogged), icon: 'fas fa-clock', baseClass: 'bg-emerald-100 text-emerald-700' });
            const hyperlinkBadge = hyperlinkCount > 0 ? createBadge({ text: hyperlinkCount, icon: 'fas fa-link', baseClass: 'bg-sky-100 text-sky-700' }) : '';
            const todoistBadge = createBadge({ text: todoistCount, icon: 'fa-solid fa-list-check', baseClass: 'bg-purple-100 text-purple-700' });

            card.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center flex-wrap gap-2">
                        <span class="font-semibold text-slate-900">${project.name || 'Untitled Project'}</span>
                        ${statusBadge}
                        ${minutesBadge}
                        ${hyperlinkBadge}
                        ${todoistBadge}
                    </div>
                </div>
            `;

            return card;
        }

        function renderMatrix() {
            clearQuadrants();
            const projectsByQuadrant = { do: [], schedule: [], delegate: [], eliminate: [] };

            Object.values(allProjects).forEach(project => {
                const quadrantId = project.quadrant || 'do';
                if (!projectsByQuadrant[quadrantId]) return;
                projectsByQuadrant[quadrantId].push(project);
            });

            Object.entries(projectsByQuadrant).forEach(([quadrantId, projects]) => {
                const container = quadrants[quadrantId];
                if (!container) return;
                projects
                    .sort((a, b) => (a.order || 0) - (b.order || 0))
                    .forEach(project => container.appendChild(createMatrixCard(project)));
            });
        }

        async function fetchTodoistTasks() {
            try {
                const response = await fetch('https://api.todoist.com/rest/v2/tasks', {
                    headers: { 'Authorization': `Bearer ${todoistAPIKey}` }
                });
                if (!response.ok) throw new Error('Failed to fetch active Todoist tasks');
                allTodoistTasks = await response.json();
                updateProjectTaskCounts();
            } catch (error) {
                console.error(error);
            }
        }

        async function fetchCompletedTodoistTasks() {
            try {
                const response = await fetch('https://api.todoist.com/sync/v9/completed/get_all', {
                    headers: { 'Authorization': `Bearer ${todoistAPIKey}` }
                });
                if (!response.ok) throw new Error('Failed to fetch completed Todoist tasks');
                const completedData = await response.json();
                allCompletedTodoistTasks = completedData.items || [];
                updateAllProjectKPIs();
            } catch (error) {
                console.error(error);
            }
        }

        function updateProjectTaskCounts() {
            if (!allProjects || !allTodoistTasks.length) {
                renderMatrix();
                return;
            }
            Object.values(allProjects).forEach(project => {
                if (!project || !project.name) return;
                const nameLower = project.name.toLowerCase();
                project.todoistCurrentCount = allTodoistTasks.filter(task => task.content.toLowerCase().includes(nameLower) && !task.is_completed).length;
            });
            renderMatrix();
        }

        function updateAllProjectKPIs() {
            if (!allProjects || !allCompletedTodoistTasks.length) {
                renderMatrix();
                return;
            }
            const timeRegex = /\|(\d+\.?\d*)\s*min\]/i;
            Object.values(allProjects).forEach(project => {
                if (!project || !project.name) return;
                const nameLower = project.name.toLowerCase();
                const relevant = allCompletedTodoistTasks.filter(task => task.content.toLowerCase().includes(nameLower));
                project.kpiMinutes = relevant.reduce((total, task) => {
                    const match = task.content.match(timeRegex);
                    return total + (match && match[1] ? parseFloat(match[1]) : 0);
                }, 0);
                project.kpiCount = relevant.length;
            });
            renderMatrix();
        }

        onValue(projectsRef, snapshot => {
            allProjects = snapshot.val() || {};
            renderMatrix();
            updateProjectTaskCounts();
            updateAllProjectKPIs();
        });

        fetchTodoistTasks();
        fetchCompletedTodoistTasks();
    </script>
</body>
</html>
